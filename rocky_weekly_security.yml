- name: Weekly Rocky full patching (update all + reboot if recommended)
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    reboot_if_recommended: true
    reboot_timeout: 1200

  tasks:
    - name: Sanity check - RedHat family only
      ansible.builtin.assert:
        that:
          - ansible_facts.os_family == "RedHat"
        fail_msg: "This playbook only supports Rocky/RHEL-family hosts."

    - name: Ensure needs-restarting support is present
      ansible.builtin.package:
        name:
          - dnf-plugins-core
          - dnf-utils
        state: present

    - name: Detect if host uses dnf5
      ansible.builtin.stat:
        path: /usr/bin/dnf5
      register: dnf5_bin

    - name: Apply full updates (dnf5)
      ansible.builtin.dnf5:
        name: "*"
        state: latest
        update_cache: true
      register: upd
      when: dnf5_bin.stat.exists

    - name: Apply full updates (dnf)
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true
      register: upd
      when: not dnf5_bin.stat.exists

    - name: Check whether reboot is recommended (needs-restarting -r) using dnf5
      ansible.builtin.command: dnf5 -q needs-restarting -r
      register: reboot_hint
      changed_when: false
      failed_when: false
      when: dnf5_bin.stat.exists

    - name: Check whether reboot is recommended (needs-restarting -r) using dnf
      ansible.builtin.command: dnf -q needs-restarting -r
      register: reboot_hint
      changed_when: false
      failed_when: false
      when: not dnf5_bin.stat.exists

    - name: Reboot if recommended
      ansible.builtin.reboot:
        msg: "Reboot triggered by Rocky weekly patching"
        reboot_timeout: "{{ reboot_timeout }}"
      when:
        - reboot_if_recommended
        - upd.changed | default(false)
        - reboot_hint.rc == 1

    - name: Summary
      ansible.builtin.debug:
        msg:
          - "updates_changed={{ upd.changed | default(false) }}"
          - "reboot_recommended={{ reboot_hint.rc == 1 }}"
          - "dnf_flavor={{ 'dnf5' if dnf5_bin.stat.exists else 'dnf' }}"
